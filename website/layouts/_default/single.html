{{- define "main" }}

<article class="post-single">
    <header class="post-header">
        {{ partial "breadcrumbs.html" . }}
        <h1 class="post-title entry-hint-parent">
            {{ .Title }}
            {{- if .Draft }}
            <span class="entry-hint" title="Draft">
                <svg xmlns="http://www.w3.org/2000/svg" height="35" viewBox="0 -960 960 960" fill="currentColor">
                    <path
                        d="M160-410v-60h300v60H160Zm0-165v-60h470v60H160Zm0-165v-60h470v60H160Zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22q0 11-4.5 22.5T862.09-380L643-160H520Zm300-263-37-37 37 37ZM580-220h38l121-122-18-19-19-18-122 121v38Zm141-141-19-18 37 37-18-19Z" />
                </svg>
            </span>
            {{- end }}
        </h1>
        {{- if .Description }}
        <div class="post-description">
            {{ .Description }}
        </div>
        {{- end }}
        {{- if not (.Param "hideMeta") }}
        <div class="post-meta">
            {{- partial "post_meta.html" . -}}
        </div>
        {{- end }}
    </header>

    {{- if (.Param "ShowToc") }}
    {{- partial "toc.html" . }}
    {{- end }}

    {{/* æ¤œç´¢ãƒãƒ¼ã®æŒ¿å…¥ */}}
    {{- if eq .Type "stations" }}
    {{ partial "search_bar.html" . }}
    {{- end }}
    {{/* ã‚¨ãƒªã‚¢ãƒšãƒ¼ã‚¸ã§ã‚‚æ¤œç´¢ãƒãƒ¼ã‚’è¡¨ç¤ºã—ãŸã„å ´åˆ */}}
    {{- if eq .Type "area" }}
    {{ partial "search_bar.html" . }}
    {{- end }}

    {{- if .Content }}
    <div class="post-content">
        {{- if not (.Param "disableAnchoredHeadings") }}
        {{- partial "anchored_headings.html" .Content -}}
        {{- else }}{{ .Content }}{{ end }}
    </div>
    {{- end }}

    <footer class="post-footer">
        {{- $tags := .Language.Params.Taxonomies.tag | default "tags" }}
        <ul class="post-tags">
            {{- range ($.GetTerms $tags) }}
            <li><a href="{{ .Permalink }}">{{ .LinkTitle }}</a></li>
            {{- end }}
        </ul>
        {{- if (.Param "ShowPostNavLinks") }}
        {{- partial "post_nav_links.html" . }}
        {{- end }}
        {{- if (and site.Params.ShowShareButtons (ne .Params.disableShare true)) }}
        {{- partial "share_icons.html" . -}}
        {{- end }}
    </footer>

    {{- if (.Param "comments") }}
    {{- partial "comments.html" . }}
    {{- end }}
</article>

{{/* ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ç”¨JSã®èª­ã¿è¾¼ã¿ (ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–) */}}
<script>
    window.onload = () => {
        const cards = document.querySelectorAll('.store-card');
        console.log("ğŸ› ï¸ Diagnostic: Found " + cards.length + " store cards.");
    };

    document.addEventListener('DOMContentLoaded', () => {
        console.log("ğŸš€ Filter.js initialized");

        const searchInput = document.getElementById('search-input');
        const sortBtn = document.getElementById('sort-price-asc');
        const chainFilters = document.querySelectorAll('.filter-chain');
        const cardsContainer = document.querySelector('.store-list-container');

        if (!cardsContainer) {
            console.error("âŒ Error: .store-list-container not found");
            return;
        }

        // NodeListã‚’é…åˆ—ã«å¤‰æ›
        let cards = Array.from(document.querySelectorAll('.store-card'));
        console.log(`ğŸ” Found ${cards.length} store cards`);

        // --- ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°é–¢æ•° ---
        const filterStores = () => {
            // å…¥åŠ›å€¤ã‚’å°æ–‡å­—åŒ–ï¼†ã‚¹ãƒšãƒ¼ã‚¹é™¤å»
            const query = searchInput ? searchInput.value.toLowerCase().replace(/[\sã€€]+/g, '') : "";

            // ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸãƒã‚§ãƒ¼ãƒ³ã®å€¤ã‚’å–å¾—
            const selectedChains = Array.from(chainFilters)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            console.log(`Filter: query="${query}", chains=[${selectedChains.join(',')}]`);

            cards.forEach(card => {
                // data-nameå±æ€§ï¼ˆãªã‘ã‚Œã°ç©ºæ–‡å­—ï¼‰ã‚’å–å¾—ãƒ»æ­£è¦åŒ–
                const name = (card.getAttribute('data-name') || "").toLowerCase().replace(/[\sã€€]+/g, '');
                const chain = card.getAttribute('data-chain');

                // æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰åˆ¤å®š
                const matchesSearch = !query || name.includes(query);

                // ãƒã‚§ãƒ¼ãƒ³åˆ¤å®š
                const matchesChain = selectedChains.length === 0 || selectedChains.includes(chain);

                if (matchesSearch && matchesChain) {
                    card.style.display = ""; // è¡¨ç¤º
                } else {
                    card.style.display = "none"; // éè¡¨ç¤º
                }
            });
        };

        // --- ã‚½ãƒ¼ãƒˆé–¢æ•° (å®‰ã„é †) ---
        const sortStores = () => {
            console.log("ğŸ’° Sorting by price...");

            // ã‚½ãƒ¼ãƒˆå®Ÿè¡Œ
            cards.sort((a, b) => {
                const priceA = parseInt(a.getAttribute('data-price')) || 99999;
                const priceB = parseInt(b.getAttribute('data-price')) || 99999;
                return priceA - priceB;
            });

            // DOMå†é…ç½®ï¼ˆappendChildã§æœ«å°¾ã«ç§»å‹•ï¼ä¸¦ã³æ›¿ãˆï¼‰
            cards.forEach(card => cardsContainer.appendChild(card));
            console.log("âœ… Sort complete");
        };

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                console.log("âŒ¨ï¸ Typing detected: " + e.target.value);
                filterStores();
            });
        } else {
            console.warn("âŒ Error: 'search-input' element not found in HTML!");
        }

        if (sortBtn) {
            sortBtn.addEventListener('click', (e) => {
                e.preventDefault();
                sortStores();
            });
        }

        if (chainFilters.length > 0) {
            chainFilters.forEach(cb => {
                cb.addEventListener('change', filterStores);
            });
        }
    });
</script>

{{- end }}{{/* end main */}}